name: Build and Deploy Model in Image

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      deploy-tag:
        description: Optional image tag suffix (defaults to the commit SHA)
        required: false
      runner-label:
        description: Self-hosted runner label to target (local or alpha cluster)
        required: true
        default: self-hosted
env:
  BASE_IMAGE: ${{ secrets.BASE_IMAGE != '' && secrets.BASE_IMAGE || 'partofaplan/weblogic-base:latest' }}
  WDT_VERSION: ${{ secrets.WDT_VERSION != '' && secrets.WDT_VERSION || '4.3.8' }}
  REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
  REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
  IMAGE_PULL_SECRET_NAME: ${{ secrets.IMAGE_PULL_SECRET_NAME != '' && secrets.IMAGE_PULL_SECRET_NAME || 'sample-domain-registry' }}
  OCR_USERNAME: ${{ secrets.OCR_USERNAME }}
  OCR_PASSWORD: ${{ secrets.OCR_PASSWORD }}
  WEBLOGIC_USERNAME: ${{ secrets.WEBLOGIC_USERNAME }}
  WEBLOGIC_PASSWORD: ${{ secrets.WEBLOGIC_PASSWORD }}
  RUNTIME_ENCRYPTION_PASSWORD: ${{ secrets.RUNTIME_ENCRYPTION_PASSWORD }}
  KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG_BASE64 }}

jobs:
  build:
    name: Build artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11
          cache: maven

      - name: Build with Maven
        run: mvn -B package

      - name: Prepare WDT archive
        run: weblogic/scripts/prepare-wdt-artifacts.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wdt-artifacts
          path: |
            sample-ear/target/sample-ear.ear
            weblogic/model/archive.zip

  deploy:
    name: Build and deploy image
    needs: build
    runs-on: ${{ inputs.runner-label == 'alpha' && fromJson('["self-hosted","alpha"]') || fromJson('["self-hosted","local"]') }}
    env:
      IMAGE_TAG: ${{ inputs.deploy-tag != '' && inputs.deploy-tag || github.sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: wdt-artifacts

      - name: Configure image metadata
        run: |
          if [[ -z "${REGISTRY_URL}" ]]; then
            echo "REGISTRY_URL secret must be set (e.g. ghcr.io/your-org)." >&2
            exit 1
          fi
          REGISTRY_PATH="${REGISTRY_URL%/}"
          REGISTRY_HOST="${REGISTRY_PATH%%/*}"
          REPOSITORY_PREFIX="${REGISTRY_PATH#${REGISTRY_HOST}}"
          REPOSITORY_PREFIX="${REPOSITORY_PREFIX#/}"
          if [[ -n "${REPOSITORY_PREFIX}" ]]; then
            IMAGE_NAME="${REGISTRY_HOST}/${REPOSITORY_PREFIX}/sample-domain:${IMAGE_TAG}"
          else
            IMAGE_NAME="${REGISTRY_HOST}/sample-domain:${IMAGE_TAG}"
          fi
          echo "Using image ${IMAGE_NAME} (login host ${REGISTRY_HOST})"
          {
            echo "IMAGE_NAME=${IMAGE_NAME}"
            echo "IMAGE_REGISTRY_HOST=${REGISTRY_HOST}"
          } >> "${GITHUB_ENV}"

      - name: Log in to Oracle Container Registry
        if: ${{ env.OCR_USERNAME != '' && env.OCR_PASSWORD != '' }}
        run: |
          echo "${OCR_PASSWORD}" | docker login container-registry.oracle.com -u "${OCR_USERNAME}" --password-stdin

      - name: Build model image
        run: |
          docker build \
            --build-arg BASE_IMAGE="${BASE_IMAGE}" \
            --build-arg WDT_VERSION="${WDT_VERSION}" \
            -t "${IMAGE_NAME}" \
            -f weblogic/image/Dockerfile \
            weblogic

      - name: Log in to target registry
        run: |
          if [[ -z "${REGISTRY_URL}" || -z "${REGISTRY_USERNAME}" || -z "${REGISTRY_PASSWORD}" ]]; then
            echo "REGISTRY_URL, REGISTRY_USERNAME, and REGISTRY_PASSWORD secrets are all required." >&2
            exit 1
          fi
          echo "${REGISTRY_PASSWORD}" | docker login "${IMAGE_REGISTRY_HOST}" -u "${REGISTRY_USERNAME}" --password-stdin

      - name: Push model image
        run: |
          set -x
          docker info
          docker --debug push "${IMAGE_NAME}"

      - name: Deploy WebLogic Domain
        run: weblogic/scripts/deploy-domain.sh
        env:
          IMAGE: ${{ env.IMAGE_NAME }}
          IMAGE_PULL_SECRET_NAME: ${{ env.IMAGE_PULL_SECRET_NAME }}
          IMAGE_PULL_SECRET_SERVER: ${{ env.IMAGE_REGISTRY_HOST }}
          IMAGE_PULL_SECRET_USERNAME: ${{ env.REGISTRY_USERNAME }}
          IMAGE_PULL_SECRET_PASSWORD: ${{ env.REGISTRY_PASSWORD }}
